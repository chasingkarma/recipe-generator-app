<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegetarian Recipe Generator</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Global Start Over Button -->
        <div class="global-nav">
            <button id="start-over-btn" class="btn btn-secondary">
                <i class="fas fa-home"></i> Start Over
            </button>
        </div>

        <header class="header">
            <h1><i class="fas fa-utensils"></i> Vegetarian Recipe Generator</h1>
            <p>Select your ingredients and discover delicious vegetarian recipes!</p>
        </header>

        <main class="main-content">
            <!-- Ingredients Selection Section -->
            <section id="ingredients-section" class="ingredients-section">
                <h2>Select Your Ingredients</h2>
                <div class="ingredients-grid" id="ingredients-grid">
                    <!-- Ingredients will be loaded here -->
                </div>
                
                <!-- Additional Ingredients Section -->
                <div class="additional-ingredients">
                    <h3>Additional Ingredients</h3>
                    <p>Add any other ingredients you have available:</p>
                    <div class="additional-inputs">
                        <div class="input-group">
                            <label for="additional-vegetables">Other Vegetables:</label>
                            <input type="text" id="additional-vegetables" placeholder="e.g., zucchini, broccoli, kale">
                        </div>
                        <div class="input-group">
                            <label for="additional-spices">Other Spices:</label>
                            <input type="text" id="additional-spices" placeholder="e.g., saffron, nutmeg, star anise">
                        </div>
                        <div class="input-group">
                            <label for="additional-grains">Other Grains:</label>
                            <input type="text" id="additional-grains" placeholder="e.g., oats, barley, couscous">
                        </div>
                        <div class="input-group">
                            <label for="additional-protein">Other Protein:</label>
                            <input type="text" id="additional-protein" placeholder="e.g., tempeh, almonds, cashews">
                        </div>
                    </div>
                </div>

                <!-- Dietary Restrictions Section -->
                <div class="dietary-restrictions">
                    <h3>Dietary Restrictions & Preferences</h3>
                    <p>Let us know about any dietary restrictions or preferences:</p>
                    <div class="input-group">
                        <label for="dietary-restrictions">Dietary Restrictions:</label>
                        <textarea id="dietary-restrictions" placeholder="e.g., can't eat spicy food, have gastrointestinal issues, prefer mild flavors, allergic to nuts, etc." rows="3"></textarea>
                    </div>
                </div>

                <!-- API Recipes Toggle -->
                <div class="api-toggle">
                    <input type="checkbox" id="include-api-recipes">
                    <label for="include-api-recipes">Include More Recipes from TheMealDB</label>
                </div>

                <div class="selected-ingredients">
                    <h3>Selected Ingredients:</h3>
                    <div id="selected-ingredients-list" class="selected-list"></div>
                </div>
                <button id="find-recipes-btn" class="btn btn-primary" disabled>
                    <i class="fas fa-search"></i> Find Recipes
                </button>
            </section>

            <!-- Recipes Section -->
            <section id="recipes-section" class="recipes-section" style="display: none;">
                <div class="recipes-header">
                    <h2>Found Recipes</h2>
                    <button id="back-to-ingredients" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Ingredients
                    </button>
                </div>
                <div id="recipes-container" class="recipes-container">
                    <!-- Recipes will be loaded here -->
                </div>
            </section>

            <!-- Recipe Detail Section -->
            <section id="recipe-detail-section" class="recipe-detail-section" style="display: none;">
                <div class="recipe-detail-header">
                    <button id="back-to-recipes" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Recipes
                    </button>
                </div>
                <div id="recipe-detail-container" class="recipe-detail-container">
                    <!-- Recipe details will be loaded here -->
                </div>
            </section>
        </main>

        <!-- Loading Spinner -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            SPOONACULAR_API_KEY: 'b787ae0032a2423eb35409bb2f4f3f10', // Your Spoonacular API key
            ENABLE_API_RECIPES: true, // Set to false to use only generated recipes
            MAX_API_RECIPES: 5, // Maximum number of API recipes to fetch
            MAX_GENERATED_RECIPES: 3, // Maximum number of generated recipes
            FORCE_AI_RECIPES: false, // Set to true to prioritize AI recipes over API
            DEBUG_MODE: true, // Enable console logging for debugging
            SHOW_NUTRITION_FACTS: true // Enable nutrition facts display
        };

        // Dynamic recipe generation system
        const APP_DATA = {
            ingredients: {
                "vegetables": [
                    "Onion", "Tomato", "Potato", "Carrot", "Bell Pepper", "Spinach", "Cauliflower", "Green Beans", "Peas", "Mushroom", 
                    "Eggplant", "Ginger", "Garlic", "Coriander Leaves", "Mint Leaves", "Curry Leaves"
                ],
                "spices": [
                    "Turmeric Powder", "Red Chili Powder", "Coriander Powder", "Cumin Powder", "Garam Masala", "Black Pepper", 
                    "Cumin Seeds", "Mustard Seeds", "Fenugreek Seeds", "Asafoetida", "Cardamom", "Cinnamon", "Cloves", "Bay Leaves"
                ],
                "grains": [
                    "Basmati Rice", "Brown Rice", "Quinoa", "Whole Wheat Flour", "Semolina", "Poha", "Puffed Rice"
                ],
                "protein": [
                    "Paneer", "Tofu", "Chickpeas", "Masoor Dal", "Toor Dal", "Chana Dal", "Urad Dal", "Kidney Beans", "Lentils"
                ]
            },
            // Nutrition data per 100g of ingredient
            nutritionData: {
                // Vegetables (per 100g)
                "Onion": { calories: 40, fat: 0.1, cholesterol: 0, sodium: 4, carbs: 9.3, fiber: 1.7, sugar: 4.7, protein: 1.1 },
                "Tomato": { calories: 18, fat: 0.2, cholesterol: 0, sodium: 5, carbs: 3.9, fiber: 1.2, sugar: 2.6, protein: 0.9 },
                "Potato": { calories: 77, fat: 0.1, cholesterol: 0, sodium: 6, carbs: 17, fiber: 2.2, sugar: 0.8, protein: 2 },
                "Carrot": { calories: 41, fat: 0.2, cholesterol: 0, sodium: 69, carbs: 9.6, fiber: 2.8, sugar: 4.7, protein: 0.9 },
                "Bell Pepper": { calories: 20, fat: 0.2, cholesterol: 0, sodium: 4, carbs: 4.6, fiber: 1.7, sugar: 2.4, protein: 0.9 },
                "Spinach": { calories: 23, fat: 0.4, cholesterol: 0, sodium: 79, carbs: 3.6, fiber: 2.2, sugar: 0.4, protein: 2.9 },
                "Cauliflower": { calories: 25, fat: 0.3, cholesterol: 0, sodium: 30, carbs: 5, fiber: 2, sugar: 1.9, protein: 1.9 },
                "Green Beans": { calories: 31, fat: 0.2, cholesterol: 0, sodium: 6, carbs: 7, fiber: 2.7, sugar: 3.3, protein: 1.8 },
                "Peas": { calories: 84, fat: 0.4, cholesterol: 0, sodium: 5, carbs: 14, fiber: 5.7, sugar: 5.7, protein: 5.4 },
                "Mushroom": { calories: 22, fat: 0.3, cholesterol: 0, sodium: 5, carbs: 3.3, fiber: 1, sugar: 1.7, protein: 3.1 },
                "Eggplant": { calories: 25, fat: 0.2, cholesterol: 0, sodium: 2, carbs: 6, fiber: 3, sugar: 3.5, protein: 1 },
                "Ginger": { calories: 80, fat: 0.8, cholesterol: 0, sodium: 13, carbs: 17.8, fiber: 2, sugar: 1.7, protein: 1.8 },
                "Garlic": { calories: 149, fat: 0.5, cholesterol: 0, sodium: 17, carbs: 33.1, fiber: 2.1, sugar: 1, protein: 6.4 },
                "Coriander Leaves": { calories: 23, fat: 0.5, cholesterol: 0, sodium: 46, carbs: 3.7, fiber: 2.8, sugar: 0.9, protein: 2.1 },
                "Mint Leaves": { calories: 44, fat: 0.7, cholesterol: 0, sodium: 31, carbs: 8.4, fiber: 6.8, sugar: 0.2, protein: 3.8 },
                "Curry Leaves": { calories: 108, fat: 1.3, cholesterol: 0, sodium: 103, carbs: 18.7, fiber: 12.3, sugar: 0.4, protein: 16.1 },
                
                // Spices (per 100g)
                "Turmeric Powder": { calories: 354, fat: 10, cholesterol: 0, sodium: 20, carbs: 65, fiber: 21, sugar: 3.2, protein: 8 },
                "Red Chili Powder": { calories: 282, fat: 12, cholesterol: 0, sodium: 1680, carbs: 49, fiber: 34, sugar: 7.2, protein: 12 },
                "Coriander Powder": { calories: 279, fat: 8.6, cholesterol: 0, sodium: 35, carbs: 52, fiber: 27, sugar: 7.3, protein: 12 },
                "Cumin Powder": { calories: 375, fat: 22, cholesterol: 0, sodium: 168, carbs: 44, fiber: 11, sugar: 2.3, protein: 18 },
                "Garam Masala": { calories: 315, fat: 12, cholesterol: 0, sodium: 45, carbs: 58, fiber: 25, sugar: 3.2, protein: 13 },
                "Black Pepper": { calories: 251, fat: 3.3, cholesterol: 0, sodium: 20, carbs: 64, fiber: 25, sugar: 0.6, protein: 10 },
                "Cumin Seeds": { calories: 375, fat: 22, cholesterol: 0, sodium: 168, carbs: 44, fiber: 11, sugar: 2.3, protein: 18 },
                "Mustard Seeds": { calories: 508, fat: 36, cholesterol: 0, sodium: 5, carbs: 28, fiber: 12, sugar: 6.8, protein: 26 },
                "Fenugreek Seeds": { calories: 323, fat: 6.4, cholesterol: 0, sodium: 67, carbs: 58, fiber: 25, sugar: 0, protein: 23 },
                "Asafoetida": { calories: 297, fat: 1.1, cholesterol: 0, sodium: 3, carbs: 68, fiber: 4.4, sugar: 0, protein: 4 },
                "Cardamom": { calories: 311, fat: 6.7, cholesterol: 0, sodium: 18, carbs: 68, fiber: 28, sugar: 0, protein: 11 },
                "Cinnamon": { calories: 247, fat: 1.2, cholesterol: 0, sodium: 10, carbs: 81, fiber: 54, sugar: 2.2, protein: 4 },
                "Cloves": { calories: 274, fat: 13, cholesterol: 0, sodium: 277, carbs: 66, fiber: 34, sugar: 2.4, protein: 6 },
                "Bay Leaves": { calories: 313, fat: 8.4, cholesterol: 0, sodium: 23, carbs: 75, fiber: 26, sugar: 0, protein: 8 },
                
                // Grains (per 100g)
                "Basmati Rice": { calories: 130, fat: 0.3, cholesterol: 0, sodium: 1, carbs: 28, fiber: 0.4, sugar: 0.1, protein: 2.7 },
                "Brown Rice": { calories: 111, fat: 0.9, cholesterol: 0, sodium: 5, carbs: 23, fiber: 1.8, sugar: 0.4, protein: 2.6 },
                "Quinoa": { calories: 120, fat: 1.9, cholesterol: 0, sodium: 7, carbs: 22, fiber: 2.8, sugar: 0.9, protein: 4.4 },
                "Whole Wheat Flour": { calories: 340, fat: 2, cholesterol: 0, sodium: 2, carbs: 72, fiber: 13, sugar: 0.4, protein: 13 },
                "Semolina": { calories: 360, fat: 1.1, cholesterol: 0, sodium: 1, carbs: 73, fiber: 3.6, sugar: 0.3, protein: 13 },
                "Poha": { calories: 360, fat: 1.1, cholesterol: 0, sodium: 1, carbs: 73, fiber: 3.6, sugar: 0.3, protein: 13 },
                "Puffed Rice": { calories: 383, fat: 0.5, cholesterol: 0, sodium: 4, carbs: 87, fiber: 1.4, sugar: 0.2, protein: 6.7 },
                
                // Protein (per 100g)
                "Paneer": { calories: 265, fat: 20, cholesterol: 72, sodium: 16, carbs: 2.7, fiber: 0, sugar: 2.7, protein: 18 },
                "Tofu": { calories: 76, fat: 4.8, cholesterol: 0, sodium: 7, carbs: 1.9, fiber: 0.3, sugar: 0.6, protein: 8.1 },
                "Chickpeas": { calories: 164, fat: 2.6, cholesterol: 0, sodium: 7, carbs: 27, fiber: 7.6, sugar: 4.8, protein: 8.9 },
                "Masoor Dal": { calories: 116, fat: 0.4, cholesterol: 0, sodium: 2, carbs: 20, fiber: 7.9, sugar: 1.8, protein: 9 },
                "Toor Dal": { calories: 343, fat: 1.5, cholesterol: 0, sodium: 2, carbs: 63, fiber: 15, sugar: 2, protein: 22 },
                "Chana Dal": { calories: 364, fat: 6.7, cholesterol: 0, sodium: 10, carbs: 61, fiber: 17, sugar: 6, protein: 21 },
                "Urad Dal": { calories: 341, fat: 1.6, cholesterol: 0, sodium: 38, carbs: 59, fiber: 18, sugar: 0, protein: 25 },
                "Kidney Beans": { calories: 127, fat: 0.5, cholesterol: 0, sodium: 1, carbs: 23, fiber: 6.4, sugar: 0.3, protein: 8.7 },
                "Lentils": { calories: 116, fat: 0.4, cholesterol: 0, sodium: 2, carbs: 20, fiber: 7.9, sugar: 1.8, protein: 9 }
            },
            // Recipe templates for dynamic generation
            recipeTemplates: {
                "curry": {
                    baseIngredients: ["Onion", "Ginger", "Garlic", "Turmeric Powder"],
                    optionalIngredients: ["Tomato", "Bell Pepper", "Spinach", "Mushroom", "Paneer", "Tofu", "Chickpeas"],
                    spices: ["Red Chili Powder", "Coriander Powder", "Cumin Powder", "Garam Masala"],
                    cookingSteps: [
                        "Heat oil in a pan and add finely chopped onions. Sauté until golden brown.",
                        "Add ginger-garlic paste and cook for 2 minutes until fragrant.",
                        "Add chopped tomatoes and cook until they become soft and mushy.",
                        "Add turmeric powder, red chili powder, coriander powder, and salt. Cook for 2 minutes.",
                        "Add main vegetables/protein and cook for 5-7 minutes on medium heat.",
                        "Add garam masala and cook for 2 minutes.",
                        "Garnish with fresh coriander leaves and serve hot."
                    ]
                },
                "poha": {
                    baseIngredients: ["Poha", "Onion", "Turmeric Powder"],
                    optionalIngredients: ["Peas", "Carrot", "Bell Pepper", "Potato", "Peanuts"],
                    spices: ["Mustard Seeds", "Cumin Seeds", "Curry Leaves", "Asafoetida"],
                    cookingSteps: [
                        "Rinse poha in water and drain. Keep aside for 10 minutes.",
                        "Heat oil in a pan and add mustard seeds. Let them crackle.",
                        "Add cumin seeds, curry leaves, and asafoetida. Cook for 30 seconds.",
                        "Add finely chopped onions and cook until translucent.",
                        "Add turmeric powder and salt. Mix well.",
                        "Add vegetables (peas, carrots, bell pepper) and cook for 2-3 minutes.",
                        "Add poha and mix gently. Cook for 2-3 minutes on low heat.",
                        "Garnish with fresh coriander and serve hot."
                    ]
                },
                "upma": {
                    baseIngredients: ["Semolina", "Onion", "Ginger"],
                    optionalIngredients: ["Carrot", "Bell Pepper", "Peas", "Tomato"],
                    spices: ["Mustard Seeds", "Cumin Seeds", "Curry Leaves", "Asafoetida"],
                    cookingSteps: [
                        "Dry roast semolina in a pan until light golden. Keep aside.",
                        "Heat oil in a pan and add mustard seeds. Let them crackle.",
                        "Add cumin seeds, curry leaves, and asafoetida. Cook for 30 seconds.",
                        "Add finely chopped onions and ginger. Cook until onions are translucent.",
                        "Add vegetables and cook for 2-3 minutes.",
                        "Add water (1:2 ratio) and bring to boil.",
                        "Add roasted semolina slowly while stirring continuously.",
                        "Cook on low heat for 3-4 minutes until done. Serve hot."
                    ]
                },
                "paratha": {
                    baseIngredients: ["Whole Wheat Flour", "Oil"],
                    optionalIngredients: ["Potato", "Paneer", "Spinach", "Cauliflower"],
                    spices: ["Cumin Seeds", "Red Chili Powder", "Garam Masala"],
                    cookingSteps: [
                        "Mix whole wheat flour with water to make a soft dough. Rest for 20 minutes.",
                        "For stuffed paratha: Mash potatoes/paneer with spices and salt.",
                        "Divide dough into equal portions and roll into small circles.",
                        "Place stuffing in center and bring edges together to seal.",
                        "Roll out gently into a circle, dusting with flour as needed.",
                        "Heat a tawa/griddle and cook paratha with oil on both sides.",
                        "Cook until golden brown spots appear. Serve hot with pickle or yogurt."
                    ]
                },
                "idli": {
                    baseIngredients: ["Urad Dal", "Rice", "Fenugreek Seeds"],
                    optionalIngredients: ["Carrot", "Bell Pepper", "Peas"],
                    spices: ["Mustard Seeds", "Curry Leaves", "Asafoetida"],
                    cookingSteps: [
                        "Soak urad dal, rice, and fenugreek seeds separately for 6-8 hours.",
                        "Grind urad dal to a smooth paste. Grind rice to a coarse paste.",
                        "Mix both pastes and let ferment overnight in a warm place.",
                        "Add salt and mix well. Batter should be thick but pourable.",
                        "Grease idli molds and pour batter. Steam for 10-12 minutes.",
                        "For vegetable idli: Add finely chopped vegetables to batter before steaming.",
                        "Serve hot with coconut chutney and sambar."
                    ]
                },
                "dosa": {
                    baseIngredients: ["Urad Dal", "Rice", "Fenugreek Seeds"],
                    optionalIngredients: ["Potato", "Onion", "Carrot"],
                    spices: ["Mustard Seeds", "Cumin Seeds", "Curry Leaves"],
                    cookingSteps: [
                        "Soak urad dal, rice, and fenugreek seeds separately for 6-8 hours.",
                        "Grind urad dal to a smooth paste. Grind rice to a fine paste.",
                        "Mix both pastes and let ferment overnight in a warm place.",
                        "Add salt and mix well. Batter should be thin and flowing.",
                        "Heat a tawa and pour batter in circular motion to make thin dosa.",
                        "Drizzle oil around edges and cook until crispy.",
                        "For masala dosa: Add potato-onion filling before folding.",
                        "Serve hot with coconut chutney and sambar."
                    ]
                },
                "stir-fry": {
                    baseIngredients: ["Ginger", "Garlic"],
                    optionalIngredients: ["Bell Pepper", "Carrot", "Mushroom", "Green Beans", "Tofu"],
                    spices: ["Black Pepper", "Soy Sauce"],
                    cookingSteps: [
                        "Heat oil in a wok over high heat.",
                        "Add minced ginger and garlic, stir-fry for 30 seconds.",
                        "Add vegetables starting with the hardest ones (carrots, broccoli).",
                        "Stir-fry for 2-3 minutes, then add softer vegetables.",
                        "Add protein (if using) and cook for 2-3 minutes.",
                        "Season with spices and soy sauce. Continue stir-frying for 2-3 minutes.",
                        "Vegetables should be crisp-tender, not mushy. Serve immediately."
                    ]
                },
                "soup": {
                    baseIngredients: ["Onion", "Ginger", "Garlic"],
                    optionalIngredients: ["Carrot", "Spinach", "Mushroom", "Peas", "Lentils"],
                    spices: ["Turmeric Powder", "Cumin Seeds", "Black Pepper"],
                    cookingSteps: [
                        "Heat oil in a pot and add cumin seeds. Let them crackle.",
                        "Add finely chopped onions and cook until translucent.",
                        "Add ginger-garlic paste and cook for 2 minutes.",
                        "Add chopped vegetables and cook for 2-3 minutes.",
                        "Add lentils (if using) and turmeric powder.",
                        "Add water and bring to boil. Simmer for 20-25 minutes.",
                        "Season with salt and pepper. Garnish with fresh herbs and serve hot."
                    ]
                },
                "rice": {
                    baseIngredients: ["Basmati Rice", "Onion", "Ginger", "Garlic"],
                    optionalIngredients: ["Carrot", "Bell Pepper", "Peas", "Mushroom"],
                    spices: ["Turmeric Powder", "Cumin Seeds", "Bay Leaves", "Cardamom"],
                    cookingSteps: [
                        "Soak rice for 30 minutes and drain.",
                        "Heat oil in a heavy-bottomed pan and add whole spices.",
                        "Add sliced onions and cook until golden brown.",
                        "Add ginger-garlic paste and cook for 2 minutes.",
                        "Add vegetables and turmeric powder. Cook for 3-4 minutes.",
                        "Add soaked rice and mix gently.",
                        "Add water (1:1.5 ratio) and bring to boil.",
                        "Cover and cook on low heat for 20 minutes until rice is done.",
                        "Let it rest for 5 minutes before serving."
                    ]
                },
                "dal": {
                    baseIngredients: ["Onion", "Ginger", "Garlic", "Turmeric Powder"],
                    optionalIngredients: ["Tomato", "Spinach", "Lentils", "Masoor Dal", "Toor Dal"],
                    spices: ["Cumin Seeds", "Red Chili Powder", "Coriander Powder", "Garam Masala"],
                    cookingSteps: [
                        "Rinse lentils thoroughly and set aside.",
                        "Heat oil in a pan and add cumin seeds. Let them crackle.",
                        "Add finely chopped onions and cook until translucent.",
                        "Add ginger-garlic paste and cook for 2 minutes.",
                        "Add chopped tomatoes and cook until soft.",
                        "Add lentils, turmeric powder, and salt.",
                        "Add water and bring to boil. Simmer for 20-25 minutes.",
                        "Add garam masala and cook for 2 minutes.",
                        "Garnish with fresh coriander and serve with rice or bread."
                    ]
                }
            },
            // Recipe names for dynamic generation
            recipeNames: {
                "curry": ["{protein} Curry", "{vegetable} Masala", "{protein} {spice} Curry", "Mixed Vegetable Curry"],
                "poha": ["Kanda Poha", "Vegetable Poha", "{vegetable} Poha", "Mixed Vegetable Poha"],
                "upma": ["{vegetable} Upma", "Mixed Vegetable Upma", "Spiced Upma", "Quick Upma"],
                "paratha": ["{vegetable} Paratha", "Aloo Paratha", "Paneer Paratha", "Mixed Vegetable Paratha"],
                "idli": ["{vegetable} Idli", "Mixed Vegetable Idli", "Spiced Idli", "Quick Idli"],
                "dosa": ["{vegetable} Dosa", "Masala Dosa", "Mixed Vegetable Dosa", "Quick Dosa"],
                "stir-fry": ["{vegetable} Stir Fry", "Asian {vegetable} Stir Fry", "Quick {vegetable} Stir Fry", "Mixed Vegetable Stir Fry"],
                "soup": ["{vegetable} Soup", "Hearty {vegetable} Soup", "Spiced {vegetable} Soup", "Mixed Vegetable Soup"],
                "rice": ["{vegetable} Rice", "Spiced {vegetable} Rice", "Mixed Vegetable Rice", "Aromatic {vegetable} Rice"],
                "dal": ["{protein} Dal", "Spiced {protein} Dal", "Mixed {protein} Dal", "Traditional {protein} Dal"]
            }
        };

        class RecipeApp {
            constructor() {
                this.selectedIngredients = [];
                this.recipes = [];
                this.currentRecipeIndex = 0;
                this.ingredients = APP_DATA.ingredients;
                this.recipeTemplates = APP_DATA.recipeTemplates;
                this.recipeNames = APP_DATA.recipeNames;
                this.apiRecipes = [];
                this.generatedRecipes = [];
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.renderIngredients();
            }

            setupEventListeners() {
                // Find recipes button
                document.getElementById('find-recipes-btn').addEventListener('click', () => {
                    this.findRecipes();
                });

                // Back to ingredients button
                document.getElementById('back-to-ingredients').addEventListener('click', () => {
                    this.showIngredientsSection();
                });

                // Back to recipes button
                document.getElementById('back-to-recipes').addEventListener('click', () => {
                    this.showRecipesSection();
                });

                // Start over button
                document.getElementById('start-over-btn').addEventListener('click', () => {
                    this.startOver();
                });

                // Additional ingredients input handlers
                this.setupAdditionalIngredientsHandlers();
            }

            setupAdditionalIngredientsHandlers() {
                const additionalInputs = [
                    'additional-vegetables',
                    'additional-spices', 
                    'additional-grains',
                    'additional-protein'
                ];

                additionalInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('blur', () => {
                            this.handleAdditionalIngredients();
                        });
                    }
                });
            }

            handleAdditionalIngredients() {
                const additionalInputs = [
                    'additional-vegetables',
                    'additional-spices',
                    'additional-grains', 
                    'additional-protein'
                ];

                let addedIngredients = [];

                additionalInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input && input.value.trim()) {
                        const ingredients = input.value.split(',').map(item => item.trim()).filter(item => item);
                        ingredients.forEach(ingredient => {
                            if (!this.selectedIngredients.includes(ingredient)) {
                                this.selectedIngredients.push(ingredient);
                                addedIngredients.push(ingredient);
                            }
                        });
                    }
                });

                if (CONFIG.DEBUG_MODE && addedIngredients.length > 0) {
                    console.log('Added additional ingredients:', addedIngredients);
                    console.log('Total selected ingredients:', this.selectedIngredients);
                }

                this.updateSelectedIngredientsDisplay();
                this.updateFindRecipesButton();
            }

            startOver() {
                // Clear all selections
                this.selectedIngredients = [];
                this.recipes = [];
                this.apiRecipes = [];
                this.generatedRecipes = [];
                
                // Clear checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Clear additional ingredients inputs
                const additionalInputs = [
                    'additional-vegetables',
                    'additional-spices',
                    'additional-grains',
                    'additional-protein'
                ];

                additionalInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = '';
                    }
                });

                // Clear dietary restrictions
                const dietaryInput = document.getElementById('dietary-restrictions');
                if (dietaryInput) {
                    dietaryInput.value = '';
                }

                // Clear API recipes toggle
                const apiToggle = document.getElementById('include-api-recipes');
                if (apiToggle) {
                    apiToggle.checked = false;
                }

                // Reset UI state - go back to ingredients section
                this.showIngredientsSection();
                
                // Re-render ingredients to auto-select spices again
                this.renderIngredients();
                
                // Clear any loading state
                this.showLoading(false);
                
                console.log('Application reset to initial state');
            }

            renderIngredients() {
                const grid = document.getElementById('ingredients-grid');
                grid.innerHTML = '';

                // Common spices to auto-select
                const autoSelectSpices = [
                    "Turmeric Powder", "Red Chili Powder", "Coriander Powder", "Cumin Powder", 
                    "Garam Masala", "Black Pepper", "Cumin Seeds", "Asafoetida", "Cardamom"
                ];

                Object.entries(this.ingredients).forEach(([category, ingredients]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'ingredient-category';
                    
                    const categoryTitle = document.createElement('h3');
                    categoryTitle.textContent = this.capitalizeFirst(category);
                    categoryDiv.appendChild(categoryTitle);

                    ingredients.forEach(ingredient => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'ingredient-item';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `ingredient-${ingredient}`;
                        checkbox.value = ingredient;
                        
                        // Auto-select common spices
                        if (autoSelectSpices.includes(ingredient)) {
                            checkbox.checked = true;
                            this.selectedIngredients.push(ingredient);
                        }
                        
                        const label = document.createElement('label');
                        label.htmlFor = `ingredient-${ingredient}`;
                        label.textContent = ingredient;
                        
                        itemDiv.appendChild(checkbox);
                        itemDiv.appendChild(label);
                        
                        // Add click event to the entire item
                        itemDiv.addEventListener('click', (e) => {
                            if (e.target.type !== 'checkbox') {
                                checkbox.checked = !checkbox.checked;
                            }
                            this.handleIngredientSelection(ingredient, checkbox.checked);
                        });
                        
                        // Add change event to checkbox
                        checkbox.addEventListener('change', (e) => {
                            this.handleIngredientSelection(ingredient, e.target.checked);
                        });
                        
                        categoryDiv.appendChild(itemDiv);
                    });
                    
                    grid.appendChild(categoryDiv);
                });
                
                // Update the display after auto-selecting spices
                this.updateSelectedIngredientsDisplay();
                this.updateFindRecipesButton();
            }

            handleIngredientSelection(ingredient, isSelected) {
                if (isSelected) {
                    if (!this.selectedIngredients.includes(ingredient)) {
                        this.selectedIngredients.push(ingredient);
                    }
                } else {
                    this.selectedIngredients = this.selectedIngredients.filter(item => item !== ingredient);
                }
                
                this.updateSelectedIngredientsDisplay();
                this.updateFindRecipesButton();
            }

            updateSelectedIngredientsDisplay() {
                const container = document.getElementById('selected-ingredients-list');
                container.innerHTML = '';
                
                this.selectedIngredients.forEach(ingredient => {
                    const ingredientDiv = document.createElement('div');
                    ingredientDiv.className = 'selected-ingredient';
                    
                    const text = document.createElement('span');
                    text.textContent = ingredient;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '×';
                    removeBtn.addEventListener('click', () => {
                        this.removeIngredient(ingredient);
                    });
                    
                    ingredientDiv.appendChild(text);
                    ingredientDiv.appendChild(removeBtn);
                    container.appendChild(ingredientDiv);
                });
            }

            removeIngredient(ingredient) {
                this.selectedIngredients = this.selectedIngredients.filter(item => item !== ingredient);
                
                // Uncheck the corresponding checkbox
                const checkbox = document.getElementById(`ingredient-${ingredient}`);
                if (checkbox) {
                    checkbox.checked = false;
                }
                
                this.updateSelectedIngredientsDisplay();
                this.updateFindRecipesButton();
            }

            updateFindRecipesButton() {
                const button = document.getElementById('find-recipes-btn');
                button.disabled = this.selectedIngredients.length < 3;
            }

            async findRecipes() {
                if (this.selectedIngredients.length < 3) {
                    alert('Please select at least 3 ingredients to find recipes. Try adding more vegetables, proteins, or spices.');
                    return;
                }

                // Handle additional ingredients before searching
                this.handleAdditionalIngredients();
                
                // Get dietary restrictions
                const dietaryRestrictions = this.getDietaryRestrictions();
                if (CONFIG.DEBUG_MODE && dietaryRestrictions.length > 0) {
                    console.log('Dietary restrictions:', dietaryRestrictions);
                }

                this.showLoading(true);
                
                try {
                    // First, try to fetch API recipes
                    const apiRecipes = await this.fetchApiRecipes();
                    this.apiRecipes = apiRecipes;
                    
                    // Then generate AI recipes
                    console.log('Selected ingredients:', this.selectedIngredients);
                    this.generatedRecipes = this.generateRecipesFromIngredients(this.selectedIngredients);
                    console.log('Generated recipes:', this.generatedRecipes);
                    
                    // Combine recipes with API recipes first, but ensure we have some AI recipes
                    let combinedRecipes = [...this.apiRecipes, ...this.generatedRecipes];
                    
                    // If we have too many API recipes and few AI recipes, add more AI recipes
                    if (this.apiRecipes.length > 3 && this.generatedRecipes.length < 2) {
                        const moreGeneratedRecipes = this.generateRecipesFromIngredients(this.selectedIngredients);
                        combinedRecipes.push(...moreGeneratedRecipes.slice(0, 2));
                    }
                    
                    // Filter recipes based on dietary restrictions
                    combinedRecipes = this.filterRecipesByDietaryRestrictions(combinedRecipes, dietaryRestrictions);
                    
                    this.recipes = combinedRecipes;
                    
                    if (CONFIG.DEBUG_MODE) {
                        console.log(`Found ${this.apiRecipes.length} API recipes and ${this.generatedRecipes.length} AI recipes`);
                        if (dietaryRestrictions.length > 0) {
                            console.log(`Applied dietary restrictions: ${dietaryRestrictions.join(', ')}`);
                            console.log(`Recipes after filtering: ${this.recipes.length}`);
                        }
                    }
                    
                    if (this.recipes.length === 0) {
                        alert('No recipes found with the selected ingredients. Try selecting different ingredients or adding more vegetables and proteins.');
                        this.showLoading(false);
                        return;
                    }
                    
                    this.showRecipesSection();
                    this.renderRecipes();
                    this.showLoading(false);
                } catch (error) {
                    console.error('Error fetching recipes:', error);
                    // Fallback to generated recipes only
                    this.generatedRecipes = this.generateRecipesFromIngredients(this.selectedIngredients);
                    this.recipes = this.generatedRecipes;
                    this.showRecipesSection();
                    this.renderRecipes();
                    this.showLoading(false);
                }
            }

            async fetchApiRecipes() {
                const apiRecipes = [];
                
                if (!CONFIG.ENABLE_API_RECIPES) {
                    return apiRecipes;
                }
                
                if (CONFIG.SPOONACULAR_API_KEY === 'YOUR_SPOONACULAR_API_KEY') {
                    console.warn('Please add your Spoonacular API key to use real recipes');
                    return apiRecipes;
                }
                
                // If FORCE_AI_RECIPES is enabled, skip API calls
                if (CONFIG.FORCE_AI_RECIPES) {
                    console.log('FORCE_AI_RECIPES enabled - skipping API calls');
                    return apiRecipes;
                }
                
                // Try to find recipes for selected ingredients
                try {
                    const ingredients = this.selectedIngredients.join(',');
                    const response = await fetch(`https://api.spoonacular.com/recipes/findByIngredients?apiKey=${CONFIG.SPOONACULAR_API_KEY}&ingredients=${encodeURIComponent(ingredients)}&number=10&ranking=2&ignorePantry=true`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        // Get detailed recipe for each result
                        for (const recipe of data.slice(0, CONFIG.MAX_API_RECIPES)) {
                            try {
                                const detailResponse = await fetch(`https://api.spoonacular.com/recipes/${recipe.id}/information?apiKey=${CONFIG.SPOONACULAR_API_KEY}`);
                                const detailData = await detailResponse.json();
                                
                                if (detailData && this.isVegetarianRecipe(detailData)) {
                                    const convertedRecipe = this.convertSpoonacularRecipeToFormat(detailData);
                                    if (convertedRecipe) {
                                        apiRecipes.push(convertedRecipe);
                                    }
                                }
                            } catch (error) {
                                console.error('Error fetching recipe details:', error);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching Spoonacular recipes:', error);
                }
                
                return apiRecipes;
            }

            convertSpoonacularRecipeToFormat(spoonacularRecipe) {
                // Extract ingredients from Spoonacular recipe
                const ingredients = [];
                if (spoonacularRecipe.extendedIngredients) {
                    spoonacularRecipe.extendedIngredients.forEach(ingredient => {
                        const isAvailable = this.selectedIngredients.some(selected => 
                            selected.toLowerCase().includes(ingredient.name.toLowerCase()) ||
                            ingredient.name.toLowerCase().includes(selected.toLowerCase())
                        );
                        
                        ingredients.push({
                            name: ingredient.name,
                            measure: ingredient.amount ? `${ingredient.amount} ${ingredient.unit}` : '',
                            available: isAvailable
                        });
                    });
                }

                // Extract instructions
                const instructions = [];
                if (spoonacularRecipe.analyzedInstructions && spoonacularRecipe.analyzedInstructions[0]) {
                    spoonacularRecipe.analyzedInstructions[0].steps.forEach(step => {
                        instructions.push(step.step);
                    });
                } else if (spoonacularRecipe.instructions) {
                    // Fallback to plain instructions
                    instructions.push(...spoonacularRecipe.instructions
                        .split('.')
                        .map(step => step.trim())
                        .filter(step => step.length > 0)
                    );
                }

                return {
                    id: spoonacularRecipe.id,
                    name: spoonacularRecipe.title,
                    time: spoonacularRecipe.readyInMinutes ? `${spoonacularRecipe.readyInMinutes} minutes` : this.estimateCookingTime(ingredients.length),
                    ingredients: ingredients,
                    instructions: instructions,
                    type: 'api',
                    source: 'Spoonacular',
                    image: spoonacularRecipe.image,
                    category: spoonacularRecipe.cuisines ? spoonacularRecipe.cuisines[0] : '',
                    servings: spoonacularRecipe.servings,
                    nutrition: this.convertSpoonacularNutrition(spoonacularRecipe.nutrition)
                };
            }

            isVegetarianRecipe(recipe) {
                // For Spoonacular recipes, check the vegetarian flag first
                if (recipe.vegetarian !== undefined) {
                    return recipe.vegetarian;
                }
                
                // Fallback: check ingredients for non-vegetarian items
                const nonVegetarianIngredients = [
                    'chicken', 'beef', 'pork', 'lamb', 'fish', 'shrimp', 'prawn', 'crab', 'lobster',
                    'meat', 'bacon', 'sausage', 'ham', 'turkey', 'duck', 'goose', 'venison',
                    'anchovy', 'tuna', 'salmon', 'cod', 'haddock', 'mackerel', 'sardine'
                ];
                
                if (recipe.extendedIngredients) {
                    return !recipe.extendedIngredients.some(ingredient => 
                        nonVegetarianIngredients.some(nonVeg => 
                            ingredient.name.toLowerCase().includes(nonVeg)
                        )
                    );
                }
                
                return true; // Default to vegetarian if we can't determine
            }

            estimateCookingTime(numIngredients) {
                const baseTime = 20;
                const additionalTime = Math.floor(numIngredients / 3) * 10;
                return `${baseTime + additionalTime} minutes`;
            }

            convertSpoonacularNutrition(spoonacularNutrition) {
                if (!spoonacularNutrition || !spoonacularNutrition.nutrients) {
                    return null;
                }
                
                const nutrition = {
                    calories: 0,
                    fat: 0,
                    cholesterol: 0,
                    sodium: 0,
                    carbs: 0,
                    fiber: 0,
                    sugar: 0,
                    protein: 0
                };
                
                // Map Spoonacular nutrition data to our format
                spoonacularNutrition.nutrients.forEach(nutrient => {
                    switch (nutrient.name.toLowerCase()) {
                        case 'calories':
                            nutrition.calories = Math.round(nutrient.amount);
                            break;
                        case 'fat':
                            nutrition.fat = Math.round(nutrient.amount * 10) / 10;
                            break;
                        case 'cholesterol':
                            nutrition.cholesterol = Math.round(nutrient.amount);
                            break;
                        case 'sodium':
                            nutrition.sodium = Math.round(nutrient.amount);
                            break;
                        case 'carbohydrates':
                            nutrition.carbs = Math.round(nutrient.amount * 10) / 10;
                            break;
                        case 'fiber':
                            nutrition.fiber = Math.round(nutrient.amount * 10) / 10;
                            break;
                        case 'sugar':
                            nutrition.sugar = Math.round(nutrient.amount * 10) / 10;
                            break;
                        case 'protein':
                            nutrition.protein = Math.round(nutrient.amount * 10) / 10;
                            break;
                    }
                });
                
                return nutrition;
            }

            getDietaryRestrictions() {
                const dietaryInput = document.getElementById('dietary-restrictions');
                if (!dietaryInput || !dietaryInput.value.trim()) {
                    return [];
                }
                
                const restrictions = dietaryInput.value.toLowerCase().split(/[,\n]/)
                    .map(item => item.trim())
                    .filter(item => item.length > 0);
                
                return restrictions;
            }

            filterRecipesByDietaryRestrictions(recipes, restrictions) {
                if (restrictions.length === 0) {
                    return recipes;
                }
                
                return recipes.filter(recipe => {
                    // Check if recipe violates any dietary restrictions
                    for (const restriction of restrictions) {
                        if (this.recipeViolatesRestriction(recipe, restriction)) {
                            return false;
                        }
                    }
                    return true;
                });
            }

            recipeViolatesRestriction(recipe, restriction) {
                const recipeText = JSON.stringify(recipe).toLowerCase();
                const ingredients = recipe.ingredients.map(ing => ing.name.toLowerCase()).join(' ');
                
                // Common dietary restriction patterns
                const restrictionPatterns = {
                    'spicy': ['chili', 'pepper', 'spicy', 'hot', 'red chili', 'black pepper'],
                    'nuts': ['nuts', 'almond', 'cashew', 'peanut', 'walnut', 'pecan'],
                    'dairy': ['milk', 'cheese', 'yogurt', 'cream', 'butter', 'dairy'],
                    'gluten': ['wheat', 'gluten', 'bread', 'flour', 'pasta'],
                    'onion': ['onion', 'garlic'],
                    'tomato': ['tomato', 'tomatoes'],
                    'mild': ['chili', 'pepper', 'spicy', 'hot', 'red chili', 'black pepper'],
                    'low sodium': ['salt', 'sodium', 'soy sauce'],
                    'low fat': ['oil', 'butter', 'cream', 'fat'],
                    'gastrointestinal': ['spicy', 'chili', 'pepper', 'hot', 'onion', 'garlic']
                };
                
                // Check if restriction matches any pattern
                for (const [pattern, keywords] of Object.entries(restrictionPatterns)) {
                    if (restriction.includes(pattern)) {
                        return keywords.some(keyword => 
                            recipeText.includes(keyword) || ingredients.includes(keyword)
                        );
                    }
                }
                
                // Check for direct ingredient matches
                return ingredients.includes(restriction);
            }

            generateRecipesFromIngredients(selectedIngredients) {
                const generatedRecipes = [];
                const dietaryRestrictions = this.getDietaryRestrictions();
                
                // Only generate recipes if we have enough selected ingredients and at least one core ingredient
                const hasCore = selectedIngredients.some(ingredient =>
                    this.ingredients.vegetables.includes(ingredient) ||
                    this.ingredients.protein.includes(ingredient) ||
                    this.ingredients.grains.includes(ingredient)
                );
                if (selectedIngredients.length < 3 || !hasCore) {
                    return [];
                }
                
                // Prioritize recipe types based on selected ingredients
                const prioritizedRecipeTypes = this.getPrioritizedRecipeTypes(selectedIngredients);
                
                // Generate recipes based on selected ingredients
                const numRecipes = Math.min(CONFIG.MAX_GENERATED_RECIPES, Math.max(2, Math.floor(selectedIngredients.length / 3)));
                
                for (let i = 0; i < numRecipes; i++) {
                    // Use prioritized recipe types, fallback to random if needed
                    const recipeType = prioritizedRecipeTypes[i] || 
                                     prioritizedRecipeTypes[Math.floor(Math.random() * prioritizedRecipeTypes.length)];
                    
                    const recipe = this.generateRecipe(recipeType, selectedIngredients, i);
                    if (recipe && recipe.ingredients.length >= 4) {
                        // Check for placeholders in the name and skip if not resolvable
                        if ((recipe.name.includes('{vegetable}') && !recipe.ingredients.some(ing => this.ingredients.vegetables.includes(ing))) ||
                            (recipe.name.includes('{protein}') && !recipe.ingredients.some(ing => this.ingredients.protein.includes(ing)))) {
                            continue;
                        }
                        
                        // Check if recipe violates dietary restrictions
                        if (dietaryRestrictions.length > 0 && this.recipeViolatesRestriction(recipe, dietaryRestrictions.join(' '))) {
                            continue;
                        }
                        
                        generatedRecipes.push(recipe);
                    }
                }
                
                return generatedRecipes;
            }

            getPrioritizedRecipeTypes(selectedIngredients) {
                const recipeTypeScores = {};
                
                // Define ingredient-to-recipe-type mappings
                const ingredientToRecipeTypes = {
                    'Poha': ['poha'],
                    'Semolina': ['upma'],
                    'Basmati Rice': ['rice'],
                    'Brown Rice': ['rice'],
                    'Quinoa': ['rice'],
                    'Whole Wheat Flour': ['paratha'],
                    'Urad Dal': ['idli', 'dosa'],
                    'Rice': ['idli', 'dosa'],
                    'Paneer': ['curry', 'paratha'],
                    'Tofu': ['curry', 'stir-fry'],
                    'Chickpeas': ['curry'],
                    'Lentils': ['dal'],
                    'Masoor Dal': ['dal'],
                    'Toor Dal': ['dal'],
                    'Chana Dal': ['dal'],
                    'Kidney Beans': ['curry'],
                    'Onion': ['curry', 'poha', 'upma', 'rice', 'dal', 'soup'],
                    'Tomato': ['curry', 'dal', 'soup'],
                    'Potato': ['curry', 'paratha', 'dosa'],
                    'Carrot': ['poha', 'upma', 'rice', 'stir-fry', 'soup'],
                    'Bell Pepper': ['curry', 'poha', 'upma', 'stir-fry', 'rice'],
                    'Spinach': ['curry', 'dal', 'paratha'],
                    'Cauliflower': ['curry', 'paratha'],
                    'Green Beans': ['curry', 'stir-fry'],
                    'Peas': ['poha', 'upma', 'rice'],
                    'Mushroom': ['curry', 'stir-fry', 'soup'],
                    'Eggplant': ['curry'],
                    'Ginger': ['curry', 'poha', 'upma', 'rice', 'dal', 'soup', 'stir-fry'],
                    'Garlic': ['curry', 'poha', 'upma', 'rice', 'dal', 'soup', 'stir-fry'],
                    'Turmeric Powder': ['curry', 'poha', 'rice', 'dal', 'soup'],
                    'Red Chili Powder': ['curry', 'dal'],
                    'Coriander Powder': ['curry', 'dal'],
                    'Cumin Powder': ['curry', 'dal'],
                    'Garam Masala': ['curry', 'dal'],
                    'Black Pepper': ['stir-fry', 'soup'],
                    'Cumin Seeds': ['poha', 'upma', 'rice', 'dal', 'soup'],
                    'Mustard Seeds': ['poha', 'upma', 'idli', 'dosa'],
                    'Curry Leaves': ['poha', 'upma', 'idli', 'dosa'],
                    'Asafoetida': ['poha', 'upma', 'idli', 'dosa']
                };
                
                // Score recipe types based on selected ingredients
                selectedIngredients.forEach(ingredient => {
                    const recipeTypes = ingredientToRecipeTypes[ingredient] || [];
                    recipeTypes.forEach(recipeType => {
                        recipeTypeScores[recipeType] = (recipeTypeScores[recipeType] || 0) + 1;
                    });
                });
                
                // Sort recipe types by score (highest first)
                const sortedRecipeTypes = Object.entries(recipeTypeScores)
                    .sort(([,a], [,b]) => b - a)
                    .map(([recipeType]) => recipeType);
                
                // If no specific matches, include all recipe types with lower priority
                const allRecipeTypes = Object.keys(this.recipeTemplates);
                const remainingTypes = allRecipeTypes.filter(type => !sortedRecipeTypes.includes(type));
                
                const result = [...sortedRecipeTypes, ...remainingTypes];
                console.log('Recipe type scores:', recipeTypeScores);
                console.log('Prioritized recipe types:', result);
                return result;
            }

            getKeyIngredientsForRecipeType(recipeType) {
                // Define key ingredients for each recipe type
                const keyIngredients = {
                    'poha': ['Poha'],
                    'upma': ['Semolina'],
                    'rice': ['Basmati Rice', 'Brown Rice', 'Quinoa'],
                    'paratha': ['Whole Wheat Flour'],
                    'idli': ['Urad Dal', 'Rice'],
                    'dosa': ['Urad Dal', 'Rice'],
                    'curry': ['Onion', 'Ginger', 'Garlic'],
                    'dal': ['Lentils', 'Masoor Dal', 'Toor Dal', 'Chana Dal', 'Urad Dal'],
                    'stir-fry': ['Ginger', 'Garlic'],
                    'soup': ['Onion', 'Ginger', 'Garlic']
                };
                
                return keyIngredients[recipeType] || [];
            }

            generateRecipe(recipeType, selectedIngredients, recipeIndex) {
                const template = this.recipeTemplates[recipeType];
                const availableIngredients = [...selectedIngredients];
                
                console.log(`Generating ${recipeType} recipe with ingredients:`, selectedIngredients);
                
                // Determine recipe ingredients based on template and available ingredients
                const recipeIngredients = [];
                
                // First, prioritize ingredients that are key for this recipe type
                const keyIngredients = this.getKeyIngredientsForRecipeType(recipeType);
                console.log(`Key ingredients for ${recipeType}:`, keyIngredients);
                keyIngredients.forEach(ingredient => {
                    if (availableIngredients.includes(ingredient)) {
                        recipeIngredients.push(ingredient);
                        availableIngredients.splice(availableIngredients.indexOf(ingredient), 1);
                    }
                });
                
                // Add base ingredients if available in selected ingredients
                template.baseIngredients.forEach(ingredient => {
                    if (availableIngredients.includes(ingredient)) {
                        recipeIngredients.push(ingredient);
                        availableIngredients.splice(availableIngredients.indexOf(ingredient), 1);
                    }
                });
                
                // Add optional ingredients from selected ingredients only
                const numOptional = Math.min(4, availableIngredients.length);
                const shuffledOptional = this.shuffleArray([...availableIngredients]);
                
                for (let i = 0; i < numOptional && i < shuffledOptional.length; i++) {
                    recipeIngredients.push(shuffledOptional[i]);
                }
                
                // Only create recipe if we have enough ingredients (at least 4)
                if (recipeIngredients.length < 4) {
                    return null;
                }
                
                // Generate recipe name
                const recipeName = this.generateRecipeName(recipeType, recipeIngredients);
                
                // Generate cooking time based on ingredients
                const cookingTime = this.generateCookingTime(recipeType, recipeIngredients.length);
                
                // Generate instructions
                const instructions = this.generateInstructions(template, recipeIngredients);
                
                // Calculate nutrition facts
                const nutrition = this.calculateRecipeNutrition(recipeIngredients);
                
                return {
                    id: Date.now() + recipeIndex,
                    name: recipeName,
                    time: cookingTime,
                    ingredients: recipeIngredients.map(ingredient => ({
                        name: ingredient,
                        measure: '',
                        available: true
                    })),
                    instructions: instructions,
                    type: 'generated',
                    source: 'AI Generated',
                    recipeType: recipeType,
                    nutrition: nutrition
                };
            }

            generateRecipeName(recipeType, ingredients) {
                const nameTemplates = this.recipeNames[recipeType];
                const template = nameTemplates[Math.floor(Math.random() * nameTemplates.length)];
                
                // Find main ingredients for naming
                const vegetables = ingredients.filter(ingredient => 
                    this.ingredients.vegetables.includes(ingredient)
                );
                const proteins = ingredients.filter(ingredient => 
                    this.ingredients.protein.includes(ingredient)
                );
                const grains = ingredients.filter(ingredient => 
                    this.ingredients.grains.includes(ingredient)
                );
                const spices = ingredients.filter(ingredient => 
                    this.ingredients.spices.includes(ingredient)
                );
                
                let name = template;
                
                // Replace placeholders with priority order
                if (name.includes('{vegetable}') && vegetables.length > 0) {
                    name = name.replace('{vegetable}', vegetables[0]);
                }
                if (name.includes('{protein}') && proteins.length > 0) {
                    name = name.replace('{protein}', proteins[0]);
                }
                if (name.includes('{spice}') && spices.length > 0) {
                    name = name.replace('{spice}', spices[0]);
                }
                
                // If no placeholders were replaced, create a more descriptive name
                if (name === template) {
                    const keyIngredient = grains[0] || vegetables[0] || proteins[0] || spices[0];
                    if (keyIngredient) {
                        name = `${keyIngredient} ${this.capitalizeFirst(recipeType)}`;
                    }
                }
                
                return name;
            }

            generateCookingTime(recipeType, numIngredients) {
                const baseTime = {
                    'curry': 25,
                    'poha': 15,
                    'upma': 20,
                    'paratha': 30,
                    'idli': 45,
                    'dosa': 40,
                    'stir-fry': 15,
                    'soup': 30,
                    'rice': 35,
                    'dal': 30
                };
                
                const base = baseTime[recipeType] || 25;
                const additionalTime = Math.floor(numIngredients / 2) * 5;
                const totalMinutes = base + additionalTime;
                
                return `${totalMinutes} minutes`;
            }

            generateInstructions(template, ingredients) {
                const instructions = [...template.cookingSteps];
                
                // Customize instructions based on ingredients
                const hasPaneer = ingredients.includes('Paneer');
                const hasTofu = ingredients.includes('Tofu');
                const hasLentils = ingredients.some(ingredient => 
                    ['Lentils', 'Masoor Dal', 'Toor Dal', 'Chana Dal', 'Urad Dal'].includes(ingredient)
                );
                
                // Modify instructions based on protein
                if (hasPaneer) {
                    instructions.splice(4, 0, "Add paneer cubes and cook for 3-4 minutes until slightly browned.");
                } else if (hasTofu) {
                    instructions.splice(4, 0, "Add tofu cubes and cook for 3-4 minutes until slightly crispy.");
                } else if (hasLentils) {
                    instructions.splice(4, 0, "Add lentils and cook for 5-7 minutes until soft.");
                }
                
                return instructions;
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            calculateRecipeNutrition(ingredients) {
                const nutrition = {
                    calories: 0,
                    fat: 0,
                    cholesterol: 0,
                    sodium: 0,
                    carbs: 0,
                    fiber: 0,
                    sugar: 0,
                    protein: 0
                };
                
                // Calculate nutrition per serving (assuming 4 servings per recipe)
                const servingsPerRecipe = 4;
                const gramsPerServing = 150; // Average serving size
                
                ingredients.forEach(ingredient => {
                    const nutritionData = this.nutritionData[ingredient];
                    if (nutritionData) {
                        // Estimate ingredient weight based on recipe type and ingredient importance
                        let ingredientWeight = this.estimateIngredientWeight(ingredient, ingredients.length);
                        
                        // Add nutrition contribution
                        nutrition.calories += (nutritionData.calories * ingredientWeight) / 100;
                        nutrition.fat += (nutritionData.fat * ingredientWeight) / 100;
                        nutrition.cholesterol += (nutritionData.cholesterol * ingredientWeight) / 100;
                        nutrition.sodium += (nutritionData.sodium * ingredientWeight) / 100;
                        nutrition.carbs += (nutritionData.carbs * ingredientWeight) / 100;
                        nutrition.fiber += (nutritionData.fiber * ingredientWeight) / 100;
                        nutrition.sugar += (nutritionData.sugar * ingredientWeight) / 100;
                        nutrition.protein += (nutritionData.protein * ingredientWeight) / 100;
                    }
                });
                
                // Round to 1 decimal place
                Object.keys(nutrition).forEach(key => {
                    nutrition[key] = Math.round(nutrition[key] * 10) / 10;
                });
                
                return nutrition;
            }

            estimateIngredientWeight(ingredient, totalIngredients) {
                // Base weights for different ingredient categories
                const baseWeights = {
                    // Main ingredients (higher weight)
                    'Basmati Rice': 50,
                    'Brown Rice': 50,
                    'Quinoa': 50,
                    'Whole Wheat Flour': 60,
                    'Semolina': 60,
                    'Poha': 60,
                    'Paneer': 40,
                    'Tofu': 40,
                    'Chickpeas': 45,
                    'Lentils': 45,
                    'Masoor Dal': 45,
                    'Toor Dal': 45,
                    'Chana Dal': 45,
                    'Urad Dal': 45,
                    'Kidney Beans': 45,
                    
                    // Vegetables (medium weight)
                    'Onion': 30,
                    'Tomato': 25,
                    'Potato': 35,
                    'Carrot': 25,
                    'Bell Pepper': 25,
                    'Spinach': 20,
                    'Cauliflower': 30,
                    'Green Beans': 25,
                    'Peas': 25,
                    'Mushroom': 25,
                    'Eggplant': 30,
                    'Ginger': 10,
                    'Garlic': 15,
                    'Coriander Leaves': 10,
                    'Mint Leaves': 5,
                    'Curry Leaves': 5,
                    
                    // Spices (low weight)
                    'Turmeric Powder': 2,
                    'Red Chili Powder': 1,
                    'Coriander Powder': 2,
                    'Cumin Powder': 1,
                    'Garam Masala': 1,
                    'Black Pepper': 1,
                    'Cumin Seeds': 1,
                    'Mustard Seeds': 1,
                    'Fenugreek Seeds': 1,
                    'Asafoetida': 1,
                    'Cardamom': 1,
                    'Cinnamon': 1,
                    'Cloves': 1,
                    'Bay Leaves': 1
                };
                
                return baseWeights[ingredient] || 20; // Default weight
            }

            formatNutritionTable(nutrition) {
                if (!nutrition || !CONFIG.SHOW_NUTRITION_FACTS) {
                    return '';
                }
                
                const dailyValues = {
                    calories: 2000,
                    fat: 65,
                    cholesterol: 300,
                    sodium: 2400,
                    carbs: 300,
                    fiber: 25,
                    sugar: 50,
                    protein: 50
                };
                
                const calculateDailyValue = (value, dailyValue) => {
                    return Math.round((value / dailyValue) * 100);
                };
                
                return `
                    <div class="nutrition-facts">
                        <h3>Nutrition Facts</h3>
                        <div class="nutrition-table">
                            <div class="nutrition-header">
                                <div class="serving-size">Serving Size: 1 serving</div>
                                <div class="servings-per-container">Servings Per Recipe: 4</div>
                            </div>
                            <div class="nutrition-divider"></div>
                            <div class="nutrition-row">
                                <span class="nutrient-name">Calories</span>
                                <span class="nutrient-value">${nutrition.calories}</span>
                            </div>
                            <div class="nutrition-divider"></div>
                            <div class="nutrition-row">
                                <span class="nutrient-name">Total Fat</span>
                                <span class="nutrient-value">${nutrition.fat}g</span>
                                <span class="daily-value">${calculateDailyValue(nutrition.fat, dailyValues.fat)}%</span>
                            </div>
                            <div class="nutrition-row">
                                <span class="nutrient-name">Cholesterol</span>
                                <span class="nutrient-value">${nutrition.cholesterol}mg</span>
                                <span class="daily-value">${calculateDailyValue(nutrition.cholesterol, dailyValues.cholesterol)}%</span>
                            </div>
                            <div class="nutrition-row">
                                <span class="nutrient-name">Sodium</span>
                                <span class="nutrient-value">${nutrition.sodium}mg</span>
                                <span class="daily-value">${calculateDailyValue(nutrition.sodium, dailyValues.sodium)}%</span>
                            </div>
                            <div class="nutrition-row">
                                <span class="nutrient-name">Total Carbohydrates</span>
                                <span class="nutrient-value">${nutrition.carbs}g</span>
                                <span class="daily-value">${calculateDailyValue(nutrition.carbs, dailyValues.carbs)}%</span>
                            </div>
                            <div class="nutrition-row">
                                <span class="nutrient-name">Dietary Fiber</span>
                                <span class="nutrient-value">${nutrition.fiber}g</span>
                                <span class="daily-value">${calculateDailyValue(nutrition.fiber, dailyValues.fiber)}%</span>
                            </div>
                            <div class="nutrition-row">
                                <span class="nutrient-name">Sugars</span>
                                <span class="nutrient-value">${nutrition.sugar}g</span>
                            </div>
                            <div class="nutrition-row">
                                <span class="nutrient-name">Protein</span>
                                <span class="nutrient-value">${nutrition.protein}g</span>
                                <span class="daily-value">${calculateDailyValue(nutrition.protein, dailyValues.protein)}%</span>
                            </div>
                        </div>
                        <div class="nutrition-note">
                            * Percent Daily Values are based on a 2,000 calorie diet.
                        </div>
                    </div>
                `;
            }

            renderRecipes() {
                const container = document.getElementById('recipes-container');
                container.innerHTML = '';
                
                this.recipes.forEach((recipe, index) => {
                    const recipeCard = document.createElement('div');
                    recipeCard.className = `recipe-card ${recipe.type}-recipe`;
                    recipeCard.addEventListener('click', () => {
                        this.showRecipeDetail(index);
                    });
                    
                    const sourceBadge = recipe.type === 'api' ? 
                        `<span class="source-badge api-badge"><i class="fas fa-check-circle"></i> ${recipe.source}</span>` :
                        `<span class="source-badge generated-badge"><i class="fas fa-magic"></i> ${recipe.source}</span>`;
                    
                    const ingredientsPreview = recipe.ingredients
                        .slice(0, 5)
                        .map(ingredient => ingredient.name)
                        .join(', ');
                    
                    recipeCard.innerHTML = `
                        <div class="recipe-header">
                            <h3>${recipe.name}</h3>
                            ${sourceBadge}
                        </div>
                        <div class="time">
                            <i class="fas fa-clock"></i>
                            ${recipe.time}
                        </div>
                        <div class="ingredients">
                            <strong>Ingredients:</strong> ${ingredientsPreview}${recipe.ingredients.length > 5 ? '...' : ''}
                        </div>
                    `;
                    
                    container.appendChild(recipeCard);
                });
            }

            showRecipeDetail(index) {
                this.currentRecipeIndex = index;
                const recipe = this.recipes[index];
                
                const sourceBadge = recipe.type === 'api' ? 
                    `<span class="source-badge api-badge"><i class="fas fa-check-circle"></i> ${recipe.source}</span>` :
                    `<span class="source-badge generated-badge"><i class="fas fa-magic"></i> ${recipe.source}</span>`;
                
                const container = document.getElementById('recipe-detail-container');
                container.innerHTML = `
                    <div class="recipe-detail-header">
                        <h1 class="recipe-title">${recipe.name}</h1>
                        ${sourceBadge}
                    </div>
                    <div class="recipe-time">
                        <i class="fas fa-clock"></i>
                        ${recipe.time}
                    </div>
                    
                    <div class="recipe-ingredients">
                        <h3>Ingredients</h3>
                        <div class="ingredients-list">
                            ${recipe.ingredients.map(ingredient => {
                                const isAvailable = ingredient.available;
                                const className = isAvailable ? 'ingredient-tag available' : 'ingredient-tag unavailable';
                                const icon = isAvailable ? '<i class="fas fa-check"></i>' : '<i class="fas fa-shopping-cart"></i>';
                                return `<div class="${className}">${icon} ${ingredient.name}${ingredient.measure ? ` (${ingredient.measure})` : ''}</div>`;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="recipe-instructions">
                        <h3>Instructions</h3>
                        <ol class="instructions-list">
                            ${recipe.instructions.map(instruction => 
                                `<li>${instruction}</li>`
                            ).join('')}
                        </ol>
                    </div>
                    
                    ${this.formatNutritionTable(recipe.nutrition)}
                    
                    <div class="recipe-navigation">
                        <button class="btn btn-secondary nav-btn" id="prev-recipe" ${index === 0 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span>Recipe ${index + 1} of ${this.recipes.length}</span>
                        <button class="btn btn-secondary nav-btn" id="next-recipe" ${index === this.recipes.length - 1 ? 'disabled' : ''}>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                `;
                
                // Add navigation event listeners
                document.getElementById('prev-recipe').addEventListener('click', () => {
                    if (this.currentRecipeIndex > 0) {
                        this.showRecipeDetail(this.currentRecipeIndex - 1);
                    }
                });
                
                document.getElementById('next-recipe').addEventListener('click', () => {
                    if (this.currentRecipeIndex < this.recipes.length - 1) {
                        this.showRecipeDetail(this.currentRecipeIndex + 1);
                    }
                });
                
                this.showRecipeDetailSection();
            }

            showIngredientsSection() {
                document.getElementById('ingredients-section').style.display = 'block';
                document.getElementById('recipes-section').style.display = 'none';
                document.getElementById('recipe-detail-section').style.display = 'none';
            }

            showRecipesSection() {
                document.getElementById('ingredients-section').style.display = 'none';
                document.getElementById('recipes-section').style.display = 'block';
                document.getElementById('recipe-detail-section').style.display = 'none';
            }

            showRecipeDetailSection() {
                document.getElementById('ingredients-section').style.display = 'none';
                document.getElementById('recipes-section').style.display = 'none';
                document.getElementById('recipe-detail-section').style.display = 'block';
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'flex' : 'none';
            }

            capitalizeFirst(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }
        }

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new RecipeApp();
        });
    </script>
</body>
</html>